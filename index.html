<!DOCTYPE html>
<html>
<head>
    <title>Crypto Prices Monitor</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>üí∞ Crypto Prices Monitor</h1>

        <div class="controls">
            <select id="coinSelect">
                <option value="">Select a coin to add</option>
            </select>
            <button onclick="addCoin()">Add Coin</button>
        </div>

        <div class="prices-table">
            <table>
                <thead>
                    <tr>
                        <th>Coin</th>
                        <th>Bybit</th>
                        <th>Binance</th>
                        <th>OKX</th>
                    </tr>
                </thead>
                <tbody id="pricesBody">
                    <!-- Prices will be populated here -->
                </tbody>
            </table>
        </div>

        <div class="status">
            <p>Connection status: <span id="status">Disconnected</span></p>
        </div>
    </div>

    <script>
        let ws;
        let availableCoins = [];

        function connectWebSocket() {
            ws = new WebSocket("ws://localhost:8000/ws/prices");

            ws.onopen = function() {
                console.log("Connected to price server");
                document.getElementById("status").textContent = "Connected";
                document.getElementById("status").style.color = "green";
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);

                if (data.available_coins) {
                    availableCoins = data.available_coins;
                    populateCoinSelect();
                }

                if (data.prices && data.tracked_coins && data.spreads) {
                    updatePricesTable(data.prices, data.tracked_coins, data.spreads);
                }
            };

            ws.onerror = function(error) {
                console.error("WebSocket error:", error);
                document.getElementById("status").textContent = "Error";
                document.getElementById("status").style.color = "red";
            };

            ws.onclose = function() {
                console.log("WebSocket connection closed");
                document.getElementById("status").textContent = "Disconnected";
                document.getElementById("status").style.color = "gray";
                setTimeout(connectWebSocket, 3000);
            };
        }

        function populateCoinSelect() {
            const select = document.getElementById('coinSelect');
            select.innerHTML = '<option value="">Select a coin to add</option>';

            availableCoins.forEach(coin => {
                const option = document.createElement('option');
                option.value = coin;
                option.textContent = coin;
                select.appendChild(option);
            });
        }

        function addCoin() {
            const select = document.getElementById('coinSelect');
            const coin = select.value;

            if (coin && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    action: "add_coin",
                    coin: coin
                }));
                select.value = "";
            }
        }

        function getSpreadColor(spreadValue) {
            if (spreadValue === undefined || spreadValue === null) {
                return 'gray';
            }
            if (spreadValue > 0) {
                return 'green';
            } else if (spreadValue < 0) {
                return 'red';
            } else {
                return 'gray';
            }
        }

        function formatPriceWithSpread(price, spread, isBybit = false) {
            if (!price) return '-';

            const priceFormatted = parseFloat(price).toFixed(4);

            if (isBybit) {
                // –î–ª—è Bybit –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–µ–Ω—É
                return `<div class="price-cell">
                    <div class="price">${priceFormatted}</div>
                </div>`;
            }

            if (!spread) {
                // –î–ª—è –¥—Ä—É–≥–∏—Ö –±–∏—Ä–∂ –±–µ–∑ —Å–ø—Ä–µ–¥–∞
                return `<div class="price-cell">
                    <div class="price">${priceFormatted}</div>
                </div>`;
            }

            // –î–ª—è –¥—Ä—É–≥–∏—Ö –±–∏—Ä–∂ —Å —Å–ø—Ä–µ–¥–æ–º
            const spreadColor = getSpreadColor(spread.value);
            return `<div class="price-cell">
                <div class="price">${priceFormatted}</div>
                <div class="spread ${spreadColor}">${spread.formatted}</div>
            </div>`;
        }

        function updatePricesTable(prices, trackedCoins, spreads) {
            const tbody = document.getElementById('pricesBody');
            tbody.innerHTML = '';

            trackedCoins.forEach(coin => {
                const row = document.createElement('tr');

                // Coin name
                const coinCell = document.createElement('td');
                coinCell.textContent = coin;
                coinCell.className = 'coin-name';
                row.appendChild(coinCell);

                // Bybit price (reference - –±–µ–∑ —Å–ø—Ä–µ–¥–∞)
                const bybitCell = document.createElement('td');
                bybitCell.innerHTML = formatPriceWithSpread(
                    prices.bybit[coin],
                    null,
                    true
                );
                row.appendChild(bybitCell);

                // Binance price with spread
                const binanceCell = document.createElement('td');
                binanceCell.innerHTML = formatPriceWithSpread(
                    prices.binance[coin],
                    spreads[coin]?.binance
                );
                row.appendChild(binanceCell);

                // OKX price with spread
                const okxCell = document.createElement('td');
                okxCell.innerHTML = formatPriceWithSpread(
                    prices.okx[coin],
                    spreads[coin]?.okx
                );
                row.appendChild(okxCell);

                tbody.appendChild(row);
            });
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        connectWebSocket();

        // –¢–∞–∫–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–Ω–µ—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        fetch('/available-coins')
            .then(response => response.json())
            .then(data => {
                availableCoins = data.available_coins;
                populateCoinSelect();
            });
    </script>
</body>
</html>
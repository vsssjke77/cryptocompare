<!DOCTYPE html>
<html>
<head>
    <title>Crypto Prices Monitor</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>üí∞ Crypto Prices Monitor</h1>

        <div class="controls">
            <select id="coinSelect">
                <option value="">Select a coin to add</option>
            </select>
            <button onclick="addCoin()">Add Coin</button>
            <button onclick="clearCoins()" class="clear-btn">Clear All</button>
        </div>

        <div class="prices-table">
            <table>
                <thead>
                    <tr>
                        <th>Coin</th>
                        <th>Bybit</th>
                        <th>Binance</th>
                        <th>OKX</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="pricesBody">
                    <!-- Prices will be populated here -->
                </tbody>
            </table>
        </div>

        <div class="status">
            <p>Connection status: <span id="status">Disconnected</span></p>
            <p>Your coins: <span id="userCoins">BTCUSDT</span></p>
        </div>
    </div>

    <script>
        let ws;
        let availableCoins = [];
        let userTrackedCoins = new Set();

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫—É–∫–∞–º–∏
        function setCookie(name, value, days = 365) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/';
        }

        function getCookie(name) {
            return document.cookie.split('; ').reduce((r, v) => {
                const parts = v.split('=');
                return parts[0] === name ? decodeURIComponent(parts[1]) : r;
            }, '');
        }

        function deleteCookie(name) {
            setCookie(name, '', -1);
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–Ω–µ—Ç–∞–º–∏ –≤ –∫—É–∫–∞—Ö
        function saveCoinsToCookie() {
            const coinsArray = Array.from(userTrackedCoins);
            setCookie('tracked_coins', JSON.stringify(coinsArray));
            console.log('Coins saved to cookie:', coinsArray);
        }

        function loadCoinsFromCookie() {
            try {
                const coinsCookie = getCookie('tracked_coins');
                if (coinsCookie) {
                    const coinsArray = JSON.parse(coinsCookie);
                    userTrackedCoins = new Set(coinsArray);
                    console.log('Coins loaded from cookie:', coinsArray);
                    return true;
                }
            } catch (error) {
                console.error('Error loading coins from cookie:', error);
            }
            return false;
        }

        function clearCoins() {
            if (confirm('Are you sure you want to remove all coins?')) {
                userTrackedCoins.clear();
                userTrackedCoins.add('BTCUSDT'); // –û—Å—Ç–∞–≤–ª—è–µ–º BTC –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                deleteCookie('tracked_coins');
                saveCoinsToCookie();
                populateCoinSelect();
                updateUserCoinsDisplay();

                // –°–æ–æ–±—â–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É –æ–± –æ—á–∏—Å—Ç–∫–µ
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        action: "clear_coins"
                    }));
                }
            }
        }

        function removeCoin(coin) {
            userTrackedCoins.delete(coin);
            saveCoinsToCookie();
            populateCoinSelect();
            updateUserCoinsDisplay();
            console.log('Coin removed:', coin);

            // –°–æ–æ–±—â–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É –æ–± —É–¥–∞–ª–µ–Ω–∏–∏ –º–æ–Ω–µ—Ç—ã
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    action: "remove_coin",
                    coin: coin
                }));
            }
        }

        function updateUserCoinsDisplay() {
            document.getElementById('userCoins').textContent = Array.from(userTrackedCoins).join(', ');
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ—Ö –º–æ–Ω–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        function sendInitialCoinsToServer() {
            if (ws && ws.readyState === WebSocket.OPEN && userTrackedCoins.size > 0) {
                const coinsArray = Array.from(userTrackedCoins);
                console.log('Sending initial coins to server:', coinsArray);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ –º–æ–Ω–µ—Ç—ã –æ–¥–Ω—É –∑–∞ –¥—Ä—É–≥–æ–π
                coinsArray.forEach(coin => {
                    ws.send(JSON.stringify({
                        action: "add_coin",
                        coin: coin
                    }));
                });
            }
        }

        function connectWebSocket() {
            ws = new WebSocket("ws://localhost:8000/ws/prices");

            ws.onopen = function() {
                console.log("Connected to price server");
                document.getElementById("status").textContent = "Connected";
                document.getElementById("status").style.color = "green";

                // –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä—É –Ω–∞—à —Å–ø–∏—Å–æ–∫ –º–æ–Ω–µ—Ç –∏–∑ –∫—É–∫–æ–≤
                setTimeout(() => {
                    sendInitialCoinsToServer();
                }, 500); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä —É—Å–ø–µ–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log("Received data:", data);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–Ω–µ—Ç—ã
                if (data.available_coins) {
                    availableCoins = data.available_coins;
                    populateCoinSelect();
                    console.log("Available coins loaded:", availableCoins.length);
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Ü–µ–Ω
                if (data.prices && data.tracked_coins && data.spreads) {
                    updatePricesTable(data.prices, data.tracked_coins, data.spreads);
                }
            };

            ws.onerror = function(error) {
                console.error("WebSocket error:", error);
                document.getElementById("status").textContent = "Error";
                document.getElementById("status").style.color = "red";
            };

            ws.onclose = function() {
                console.log("WebSocket connection closed");
                document.getElementById("status").textContent = "Disconnected";
                document.getElementById("status").style.color = "gray";
                setTimeout(connectWebSocket, 3000);
            };
        }

        function populateCoinSelect() {
            const select = document.getElementById('coinSelect');
            const currentValue = select.value;

            select.innerHTML = '<option value="">Select a coin to add</option>';

            // –§–∏–ª—å—Ç—Ä—É–µ–º –º–æ–Ω–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã
            const availableCoinsFiltered = availableCoins.filter(coin => !userTrackedCoins.has(coin));

            console.log("Filtered coins for select:", availableCoinsFiltered);

            if (availableCoinsFiltered.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "All coins added";
                option.disabled = true;
                select.appendChild(option);
            } else {
                availableCoinsFiltered.forEach(coin => {
                    const option = document.createElement('option');
                    option.value = coin;
                    option.textContent = coin;
                    select.appendChild(option);
                });
            }

            if (currentValue && availableCoinsFiltered.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        function addCoin() {
            const select = document.getElementById('coinSelect');
            const coin = select.value;

            if (coin && ws.readyState === WebSocket.OPEN) {
                console.log("Adding coin:", coin);

                // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–Ω–µ—Ç—É –ª–æ–∫–∞–ª—å–Ω–æ
                userTrackedCoins.add(coin);
                saveCoinsToCookie();
                populateCoinSelect();
                updateUserCoinsDisplay();

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                ws.send(JSON.stringify({
                    action: "add_coin",
                    coin: coin
                }));

                select.value = "";
            } else {
                console.log("Cannot add coin:", coin, "WebSocket state:", ws.readyState);
            }
        }

        function getSpreadColor(spreadValue) {
            if (spreadValue === undefined || spreadValue === null) {
                return 'gray';
            }
            if (spreadValue > 0) {
                return 'green';
            } else if (spreadValue < 0) {
                return 'red';
            } else {
                return 'gray';
            }
        }

        function formatPriceWithSpread(price, spread, isBybit = false) {
            if (!price) return '-';

            const priceFormatted = parseFloat(price).toFixed(4);

            if (isBybit) {
                return `<div class="price-cell">
                    <div class="price">${priceFormatted}</div>
                </div>`;
            }

            if (!spread) {
                return `<div class="price-cell">
                    <div class="price">${priceFormatted}</div>
                </div>`;
            }

            const spreadColor = getSpreadColor(spread.value);
            return `<div class="price-cell">
                <div class="price">${priceFormatted}</div>
                <div class="spread ${spreadColor}">${spread.formatted}</div>
            </div>`;
        }

        function updatePricesTable(prices, trackedCoins, spreads) {
            const tbody = document.getElementById('pricesBody');
            tbody.innerHTML = '';

            trackedCoins.forEach(coin => {
                const row = document.createElement('tr');

                // Coin name
                const coinCell = document.createElement('td');
                coinCell.textContent = coin;
                coinCell.className = 'coin-name';
                row.appendChild(coinCell);

                // Bybit price
                const bybitCell = document.createElement('td');
                bybitCell.innerHTML = formatPriceWithSpread(
                    prices.bybit[coin],
                    null,
                    true
                );
                row.appendChild(bybitCell);

                // Binance price with spread
                const binanceCell = document.createElement('td');
                binanceCell.innerHTML = formatPriceWithSpread(
                    prices.binance[coin],
                    spreads[coin]?.binance
                );
                row.appendChild(binanceCell);

                // OKX price with spread
                const okxCell = document.createElement('td');
                okxCell.innerHTML = formatPriceWithSpread(
                    prices.okx[coin],
                    spreads[coin]?.okx
                );
                row.appendChild(okxCell);

                // Remove button
                const actionCell = document.createElement('td');
                if (coin !== 'BTCUSDT') { // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è BTC –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'Remove';
                    removeBtn.className = 'remove-btn';
                    removeBtn.onclick = () => removeCoin(coin);
                    actionCell.appendChild(removeBtn);
                }
                row.appendChild(actionCell);

                tbody.appendChild(row);
            });
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–Ω–µ—Ç—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        async function loadAvailableCoins() {
            try {
                const response = await fetch('/available-coins');
                const data = await response.json();
                availableCoins = data.available_coins;

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–Ω–µ—Ç—ã –∏–∑ –∫—É–∫–æ–≤
                const hasCookies = loadCoinsFromCookie();
                if (!hasCookies || userTrackedCoins.size === 0) {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –∫—É–∫–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º BTC –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    userTrackedCoins.add('BTCUSDT');
                    saveCoinsToCookie();
                }

                populateCoinSelect();
                updateUserCoinsDisplay();
                console.log("Available coins loaded on startup:", availableCoins.length);
                console.log("User coins from cookie:", Array.from(userTrackedCoins));
            } catch (error) {
                console.error("Failed to load available coins:", error);
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableCoins();
            connectWebSocket();
        });
    </script>
</body>
</html>